using LinearEphemeris
using Plots

function read_file(data_file)

    # open(data_file, "r") do file
    #     lines = readlines(file) # lines does not exist outside this statement!!
    # end
    file = open(data_file, "r")
    lines = readlines(file)
    close(file)

    T0s = Float64[]
    err_T0s = Float64[]

    for line in lines
        if length(line) > 0 && line[1:1] != "#"
            l = split(strip(line))
            xT = parse(Float64, l[1])
            push!(T0s, xT)
            xeT = parse(Float64, l[2])
            push!(err_T0s, xeT)
        end
    end

    return T0s, err_T0s
end


function example()

    BOOTSTRAP = true
    # nboot=3 * get_nboot(length(T0s))
    nboot = nothing
    do_plot = true
    show_gui=false
    seed = 42
    tscale = BTJD
    
    
    # --- Kepler-9 b --- #
    planet_b = "Kepler-9 b"
    println("\n$planet_b")
    T0b, err_T0b = read_file("Kepler-9b_T0s.dat")
    Tref_in = 2454977.500 # 2454977.512 ± 0.065 # Borsato+ 2019
    Pref_in = 19.245 # 19.2460 ± 0.0015 # Borsato+ 2019
    sources = ["Kepler" for i in 1:length(T0b)]
    plot_file = "Kepler-9b_OC.png"
    plt_b = full_linear_ephemeris_analysis(
        T0b,
        err_T0b;
        Tref_in = Tref_in,
        Pref_in = Pref_in,
        tscale = tscale,
        sources = sources,
        bootstrap = BOOTSTRAP,
        nboot = nboot,
        return_distribution = BOOTSTRAP,
        do_plot = do_plot,
        show_gui = show_gui,
        plot_file = plot_file,
        seed = seed,
    )
    println("DONE $planet_b")
    println("updates title")
    title!(plt_b, planet_b, titlefontsize=18)
    println("get xlims of plt_b")
    xlim_b = xlims(plt_b)
    xlabel!(plt_b, "")

    # --- Kepler-9 c --- #
    planet_c = "Kepler-9 c"
    println("\n$planet_c")
    T0c, err_T0c = read_file("Kepler-9c_T0s.dat")
    Tref_in = 2454968.834 # 2454968.84 ± 0.20 # Borsato+ 2019
    Pref_in = 38.9485 # 38.9492 ± 0.0093 # Borsato+ 2019
    sources = ["Kepler" for i in 1:length(T0c)]
    plot_file = "Kepler-9c_OC.png"
    plt_c = full_linear_ephemeris_analysis(
        T0c,
        err_T0c;
        Tref_in = Tref_in,
        Pref_in = Pref_in,
        tscale = tscale,
        sources = sources,
        bootstrap = BOOTSTRAP,
        nboot = nboot,
        return_distribution = BOOTSTRAP,
        do_plot = do_plot,
        show_gui = show_gui,
        plot_file = plot_file,
        seed = seed,
    )
    println("DONE $planet_c")
    println("updates title")
    title!(plt_c, planet_c, titlefontsize=18)
    println("get xlims of plt_c")
    xlim_c = xlims(plt_c)
    xlim = (min(xlim_b[1], xlim_c[1]), max(xlim_b[2], xlim_c[2]))
    println("updates xlim of both plots")
    xlims!(plt_b, xlim)
    xlims!(plt_c, xlim)

    println("sets layout")
    l = @layout [ a; b]
    # l = grid(2,1)
    println("do plot of both planets in one file")
    plt_full = plot(
        plt_b,
        plt_c,
        layout=l,
        legend=:outerright,
        legendfontsize= 14,
    )
    plot_file = "Kepler-9_bc_OC.pdf"
    println(plot_file)
    savefig(plt_full, plot_file)
    
    return 
end

example()

## OUTPUT OF exaple()

# Kepler-9 b

# --- Linear Ephemeris ---
# WLS fit

# Tref = 2454977.6993043 +/- 0.0001919
# Pref = 19.2430374 +/- 0.0000041

# stats:
# n_data = 70 n_fit = 2
# std(res) = 0.27280520548813214 d = 6.547324931715171 hours
# percentile(|res|, 68.27th) = 0.31048122462364847 d = 7.451549390967563 hours
# χ^2 = 1.0632055119501138e7 χ^2/dof = 156353.75175736967 dof = 68
# BIC = 1.0632063616491621e7 AIC = 1.0632059119501138e7
# lnL = -5.3158146410122095e6 lnc = -425.8374767184997
# BIC_lnL = 1.0631637779014902e7 AIC_lnL = 1.0631633282024419e7

# TTV amp = 0.3968479 d = 9.5243493 hours

# Running Bootstrap with nboot = 1260
# Tref (bootstrap): median = 2454977.7809456 rms = 0.1094818
# Pref (bootstrap): median = 19.2429772 rms = 0.0014582

# Error propagation plot with bootstrap analysis
# plotting $T_\mathrm{ref}$
# best   2.454977699304258e6
# median 2.454977780945638e6
# rms    0.10948183702947574
# nboot  1260
# plotting $P_\mathrm{ref}$
# best   19.24303739131715
# median 19.242977247515853
# rms    0.0014581922086151025
# nboot  1260
# Error propagation plot with formal error

# # O-C SUMMARY
# # epoch             T0s    err_T0s       OC_d       OC_m       OC_s         T0s_lin               source
#      -0  2454977.249920   0.001114  -0.449384   -647.113   -38826.8  2454977.699304               Kepler
#       1  2454996.483618   0.000766  -0.458723   -660.562   -39633.7  2454996.942342               Kepler
#       3  2455034.953794   0.000811  -0.474623   -683.457   -41007.4  2455035.428416               Kepler
#       4  2455054.192313   0.002079  -0.479141   -689.963   -41397.8  2455054.671454               Kepler
#       5  2455073.434662   0.002905  -0.479830   -690.955   -41457.3  2455073.914491               Kepler
#       7  2455111.928660   0.001479  -0.471906   -679.545   -40772.7  2455112.400566               Kepler
#       8  2455131.171494   0.000924  -0.472109   -679.837   -40790.2  2455131.643603               Kepler
#       9  2455150.431708   0.000856  -0.454933   -655.103   -39306.2  2455150.886641               Kepler
#      10  2455169.682399   0.000840  -0.447279   -644.081   -38644.9  2455170.129678               Kepler
#      11  2455188.947585   0.000897  -0.425130   -612.187   -36731.2  2455189.372716               Kepler
#      12  2455208.203261   0.000582  -0.412492   -593.989   -35639.3  2455208.615753               Kepler
#      13  2455227.474208   0.001646  -0.384582   -553.798   -33227.9  2455227.858790               Kepler
#      14  2455246.737234   0.000572  -0.364594   -525.015   -31500.9  2455247.101828               Kepler
#      15  2455266.015656   0.002664  -0.329209   -474.060   -28443.6  2455266.344865               Kepler
#      16  2455285.281965   0.001272  -0.305938   -440.551   -26433.0  2455285.587903               Kepler
#      17  2455304.564339   0.000838  -0.266601   -383.905   -23034.3  2455304.830940               Kepler
#      18  2455323.836144   0.000624  -0.237833   -342.480   -20548.8  2455324.073977               Kepler
#      19  2455343.118371   0.000736  -0.198644   -286.048   -17162.9  2455343.317015               Kepler
#      20  2455362.396358   0.000573  -0.163694   -235.720   -14143.2  2455362.560052               Kepler
#      21  2455381.678642   0.001330  -0.124448   -179.205   -10752.3  2455381.803089               Kepler
#      22  2455400.956821   0.001105  -0.089306   -128.600    -7716.0  2455401.046127               Kepler
#      23  2455420.241010   0.001247  -0.048154    -69.342    -4160.5  2455420.289164               Kepler
#      24  2455439.519350   0.001124  -0.012852    -18.507    -1110.4  2455439.532202               Kepler
#      25  2455458.803341   0.000634   0.028102     40.466     2428.0  2455458.775239               Kepler
#      26  2455478.080404   0.000600   0.062127     89.463     5367.8  2455478.018276               Kepler
#      27  2455497.360807   0.000576   0.099493    143.269     8596.2  2455497.261314               Kepler
#      28  2455516.635507   0.000527   0.131156    188.865    11331.9  2455516.504351               Kepler
#      29  2455535.910620   0.000558   0.163232    235.054    14103.2  2455535.747389               Kepler
#      31  2455574.452584   0.000570   0.219121    315.534    18932.0  2455574.233463               Kepler
#      32  2455593.718385   0.000519   0.241885    348.314    20898.8  2455593.476501               Kepler
#      33  2455612.982295   0.000600   0.262757    378.370    22702.2  2455612.719538               Kepler
#      34  2455632.242973   0.000791   0.280397    403.772    24226.3  2455631.962576               Kepler
#      35  2455651.498120   0.000526   0.292507    421.209    25272.6  2455651.205613               Kepler
#      36  2455670.752765   0.000492   0.304115    437.926    26275.5  2455670.448650               Kepler
#      37  2455690.002114   0.000550   0.310426    447.014    26820.8  2455689.691688               Kepler
#      38  2455709.248591   0.000600   0.313866    451.967    27118.0  2455708.934725               Kepler
#      39  2455728.491432   0.000528   0.313670    451.685    27101.1  2455728.177763               Kepler
#      40  2455747.731741   0.000571   0.310941    447.756    26865.3  2455747.420800               Kepler
#      41  2455766.966912   0.000597   0.303074    436.427    26185.6  2455766.663837               Kepler
#      42  2455786.204323   0.000628   0.297448    428.325    25699.5  2455785.906875               Kepler
#      43  2455805.433497   0.000588   0.283585    408.363    24501.8  2455805.149912               Kepler
#      44  2455824.663898   0.000558   0.270949    390.166    23410.0  2455824.392949               Kepler
#      45  2455843.889077   0.000592   0.253090    364.450    21867.0  2455843.635987               Kepler
#      46  2455863.114682   0.000595   0.235658    339.348    20360.9  2455862.879024               Kepler
#      47  2455882.336827   0.000486   0.214766    309.263    18555.8  2455882.122062               Kepler
#      48  2455901.561788   0.000558   0.196688    283.231    16993.9  2455901.365099               Kepler
#      49  2455920.781258   0.000563   0.173122    249.295    14957.7  2455920.608136               Kepler
#      50  2455940.003186   0.000566   0.152012    218.897    13133.8  2455939.851174               Kepler
#      52  2455978.442389   0.000491   0.105140    151.402     9084.1  2455978.337249               Kepler
#      54  2456016.880667   0.000638   0.057344     82.575     4954.5  2456016.823323               Kepler
#      55  2456036.099592   0.000622   0.033232     47.854     2871.2  2456036.066361               Kepler
#      56  2456055.321194   0.000789   0.011796     16.986     1019.1  2456055.309398               Kepler
#      57  2456074.539529   0.000567  -0.012906    -18.585    -1115.1  2456074.552436               Kepler
#      58  2456093.759383   0.000580  -0.036090    -51.970    -3118.2  2456093.795473               Kepler
#      59  2456112.978281   0.000580  -0.060229    -86.730    -5203.8  2456113.038510               Kepler
#      60  2456132.196817   0.000611  -0.084731   -122.013    -7320.8  2456132.281548               Kepler
#      61  2456151.418340   0.000532  -0.106245   -152.993    -9179.6  2456151.524585               Kepler
#      62  2456170.637269   0.000580  -0.130353   -187.709   -11262.5  2456170.767623               Kepler
#      63  2456189.859930   0.000615  -0.150730   -217.051   -13023.1  2456190.010660               Kepler
#      64  2456209.079788   0.000584  -0.173909   -250.430   -15025.8  2456209.253697               Kepler
#      65  2456228.300681   0.000724  -0.196054   -282.318   -16939.1  2456228.496735               Kepler
#      67  2456266.743620   0.000504  -0.239190   -344.433   -20666.0  2456266.982809               Kepler
#      68  2456285.966051   0.000600  -0.259795   -374.106   -22446.3  2456286.225847               Kepler
#      69  2456305.191972   0.000759  -0.276912   -398.754   -23925.2  2456305.468884               Kepler
#      70  2456324.411433   0.000649  -0.300489   -432.704   -25962.2  2456324.711922               Kepler
#      71  2456343.634372   0.000805  -0.320587   -461.645   -27698.7  2456343.954959               Kepler
#      72  2456362.858718   0.000582  -0.339278   -488.560   -29313.6  2456363.197996               Kepler
#      73  2456382.082178   0.000694  -0.358855   -516.752   -31005.1  2456382.441034               Kepler
#      74  2456401.306254   0.000680  -0.377818   -544.057   -32643.4  2456401.684071               Kepler
#      75  2456420.533938   0.000772  -0.393170   -566.165   -33969.9  2456420.927109               Kepler

# DONE Kepler-9 b
# updates title
# get xlims of plt_b

# Kepler-9 c

# --- Linear Ephemeris ---
# WLS fit

# Tref = 2454968.4797086 +/- 0.0003125
# Pref = 38.9628177 +/- 0.0000133

# stats:
# n_data = 37 n_fit = 2
# std(res) = 0.6202403774021502 d = 14.885769057651604 hours
# percentile(|res|, 68.27th) = 0.7617905612345784 d = 18.282973469629884 hours
# χ^2 = 1.835256377682592e7 χ^2/dof = 524358.9650521692 dof = 35
# BIC = 1.8352570998661745e7 AIC = 1.835256777682592e7
# lnL = -9.176161896397077e6 lnc = -239.98403176546515
# BIC_lnL = 1.835233101462998e7 AIC_lnL = 1.8352327792794153e7

# TTV amp = 0.8768307 d = 21.0439366 hours

# Running Bootstrap with nboot = 481
# Tref (bootstrap): median = 2454968.3696787 rms = 0.2328937
# Pref (bootstrap): median = 38.9623505 rms = 0.0094999

# Error propagation plot with bootstrap analysis
# plotting $T_\mathrm{ref}$
# best   2.454968479708641e6
# median 2.4549683696786757e6
# rms    0.23289371266588568
# nboot  481
# plotting $P_\mathrm{ref}$
# best   38.96281766939192
# median 38.96235050540715
# rms    0.009499939705941072
# nboot  481
# Error propagation plot with formal error

# # O-C SUMMARY
# # epoch             T0s    err_T0s       OC_d       OC_m       OC_s         T0s_lin               source
#       0  2454969.306465   0.000867   0.826757   1190.530    71431.8  2454968.479709               Kepler
#       1  2455008.331532   0.001347   0.889005   1280.168    76810.1  2455007.442526               Kepler
#       2  2455047.335395   0.000749   0.930051   1339.274    80356.4  2455046.405344               Kepler
#       3  2455086.313067   0.001885   0.944905   1360.663    81639.8  2455085.368162               Kepler
#       4  2455125.262683   0.001301   0.931703   1341.653    80499.2  2455124.330979               Kepler
#       5  2455164.183616   0.002071   0.889819   1281.339    76880.4  2455163.293797               Kepler
#       6  2455203.071492   0.000995   0.814878   1173.424    70405.4  2455202.256615               Kepler
#       7  2455241.930462   0.000866   0.711029   1023.882    61432.9  2455241.219432               Kepler
#       8  2455280.764452   0.001696   0.582202    838.371    50302.3  2455280.182250               Kepler
#       9  2455319.577610   0.001234   0.432542    622.861    37371.7  2455319.145068               Kepler
#      10  2455358.377592   0.001464   0.269706    388.377    23302.6  2455358.107885               Kepler
#      11  2455397.170023   0.001546   0.099320    143.021     8581.3  2455397.070703               Kepler
#      12  2455435.958615   0.000682  -0.074905   -107.864    -6471.8  2455436.033521               Kepler
#      13  2455474.753078   0.000700  -0.243260   -350.295   -21017.7  2455474.996338               Kepler
#      14  2455513.561995   0.000753  -0.397161   -571.912   -34314.7  2455513.959156               Kepler
#      15  2455552.386704   0.000770  -0.535270   -770.788   -46247.3  2455552.921974               Kepler
#      16  2455591.237816   0.000809  -0.646975   -931.645   -55898.7  2455591.884791               Kepler
#      17  2455630.112423   0.000867  -0.735186  -1058.668   -63520.1  2455630.847609               Kepler
#      18  2455669.021489   0.000796  -0.788938  -1136.071   -68164.2  2455669.810427               Kepler
#      19  2455707.964488   0.000710  -0.808756  -1164.609   -69876.6  2455708.773244               Kepler
#      20  2455746.934662   0.000919  -0.801400  -1154.016   -69241.0  2455747.736062               Kepler
#      21  2455785.936487   0.000689  -0.762392  -1097.845   -65870.7  2455786.698880               Kepler
#      22  2455824.958965   0.000744  -0.702733  -1011.935   -60716.1  2455825.661697               Kepler
#      23  2455864.000505   0.000741  -0.624010   -898.574   -53914.4  2455864.624515               Kepler
#      25  2455942.117226   0.000764  -0.432925   -623.411   -37404.7  2455942.550150               Kepler
#      26  2455981.186397   0.001108  -0.326571   -470.262   -28215.7  2455981.512968               Kepler
#      27  2456020.258107   0.000762  -0.217679   -313.457   -18807.4  2456020.475786               Kepler
#      28  2456059.331489   0.000708  -0.107114   -154.244    -9254.6  2456059.438603               Kepler
#      29  2456098.404979   0.000799   0.003558      5.123      307.4  2456098.401421               Kepler
#      30  2456137.478409   0.000762   0.114170    164.405     9864.3  2456137.364239               Kepler
#      31  2456176.552899   0.000789   0.225842    325.213    19512.8  2456176.327056               Kepler
#      32  2456215.626823   0.000749   0.336949    485.206    29112.4  2456215.289874               Kepler
#      33  2456254.697385   0.000800   0.444694    640.359    38421.5  2456254.252692               Kepler
#      34  2456293.766682   0.000766   0.551172    793.688    47621.3  2456293.215509               Kepler
#      35  2456332.834461   0.000724   0.656134    944.833    56690.0  2456332.178327               Kepler
#      36  2456371.902114   0.000680   0.760969   1095.795    65747.7  2456371.141145               Kepler
#      37  2456410.960283   0.000834   0.856321   1233.102    73986.1  2456410.103962               Kepler

# DONE Kepler-9 c
# updates title
# get xlims of plt_c
# updates xlim of both plots
# sets layout
# do plot of both planets in one file
# Kepler-9_bc_OC.pdf